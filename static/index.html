<!DOCTYPE html>
<html>
<head>
    <title>pyRadio</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style type="text/css">
            @keyframes toGreen {
                from {
                    background-color: red;
                }
                to {
                    background-color: green;
                }
            }
            @keyframes toRed {
                from {
                    background-color: green;
                }
                to {
                    background-color: red;
                }
            }
        
            .outer {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh; /* Высота всего окна браузера */
                animation-name: toGreen;
            }
    </style>
    <link href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body>
    <div class="outer">
        <div class="inner bg-white rounded-lg shadow-md p-6">
            <p class="font-bold text-4xl text-gray-900 dark:text-white text-center mb-5">pyRadio</p>
            <button onclick="connect()" type="button" class="focus:outline-none text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2 me-2 mb-2 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">Connect</button>
            <button onclick="disconnect()" type="button" class="focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800">Disconnect</button>
            <button onclick="previous()" type="button" class="focus:outline-none text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Previous</button>
            <button onclick="next()" type="button" class="focus:outline-none text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Next</button>
            <p id="status">Status: Disconnected</p>
        </div>
    </div>

    <script>
        let ws = null;
        let audioContext = null;
        let audioQueue = [];

        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                return;
            }

            ws = new WebSocket(`ws://${window.location.host}/ws`);
            updateStatus('Connecting...');
            
            ws.onopen = () => {
                console.log('Connected to server');
                initializeAudio();
                updateStatus('Radio is playing')
            };
            
            ws.onmessage = async (event) => {
                if (event.data instanceof Blob) {
                    // Преобразование Blob в ArrayBuffer
                    const arrayBuffer = await event.data.arrayBuffer();
                    await processAudioData(arrayBuffer);
                } else if (typeof event.data === 'string') {
                    console.log('Text message:', event.data);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus('Error: ' + error);
            };
            
            ws.onclose = () => {
                console.log('Disconnected from server');
                updateStatus('Disconnected');
            };
        }
        function next() {
                fetch(`http://${window.location.host}/next`)
                    .then(response => response.json()) // Обработка ответа как JSON
                    .catch(error => {
                        console.error('Ошибка:', error);
                    });
        }
        function previous() {
                fetch(`http://${window.location.host}/previous`)
                    .then(response => response.json()) // Обработка ответа как JSON
                    .catch(error => {
                        console.error('Ошибка:', error);
                    });
        }

        function initializeAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('Audio context initialized');
            }
        }

        async function processAudioData(arrayBuffer) {
            try {
                if (!audioContext) {
                    initializeAudio();
                }

                // Декодирование аудио данных
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // Воспроизведение
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.start();
                
                console.log('Audio played successfully');
                
            } catch (error) {
                console.error('Audio processing error:', error);
                updateStatus('Audio error: ' + error.message);
            }
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = 'Status: ' + message;
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            if (audioContext) {
                audioContext.close().then(() => {
                    audioContext = null;
                    console.log('Audio context closed');
                });
            }
            updateStatus('Disconnected');
        }

        // Автоподключение при загрузке страницы
        window.addEventListener('load', connect);
    </script>
</body>
</html>